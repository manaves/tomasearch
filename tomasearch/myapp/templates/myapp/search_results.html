<!-- templates/myapp/search_results.html -->
{% load custom_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>TomaSearch | Results</title>
		<style>
			body {
				font-family: 'Trebuchet MS', sans-serif;
				background-color: #f8f8f8;
				padding: 40px;
			}

			/* Download CSV button */
			.btn {
				display: inline-block;
				margin-bottom: 20px;
				padding: 10px 20px;
				background-color: #e48070;
				color: #fff;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 16px;
				text-decoration: none;
				font-weight: bold;
				text-align: center;
			}

			.btn:hover { background-color: #cf6d5d; }

			table {
				table-layout: auto;
				border-collapse: collapse;
				width: 96%;
				margin: 0 auto;
				background-color: #fff;
				box-shadow: 0 4px 8px rgba(0,0,0,0.1);
				border-radius: 8px;
				overflow: hidden;
			}

			th, td {
				padding: 12px 16px;
				text-align: center;
				white-space: nowrap;
			}

			th {
				background-color: #e48070;
				font-weight: bold;
				color: rgba(0, 0, 0, 0.9);
				position: relative;
				cursor: pointer;
			}

			tr:nth-child(even) { background-color: #f2f2f2; }

			tr:hover {
				background-color: #e0e0e0;
				text-align: center;
			}

			.sort-btn {
				background: transparent;
				border: none;
				cursor: pointer;
				font-weight: bold;
				margin-left: 5px;
			}

			.dropdown div {
				padding: 5px 10px;
				cursor: pointer;
			}

			.dropdown div:hover { background-color: #eee; }

			#scrollTopBtn {
				display: none;
				position: fixed;
				bottom: 30px;
				right: 30px;
				z-index: 999;
				background-color: #e48070;
				color: white;
				border: none;
				outline: none;
				padding: 12px 16px;
				border-radius: 50%;
				font-size: 20px;
				cursor: pointer;
				box-shadow: 0 4px 6px rgba(0,0,0,0.2);
				transition: background-color 0.3s ease;
			}

			#scrollTopBtn:hover { background-color: #cf6d5d; }
		</style>
	</head>

	<body>
		<!-- Logo -->
		<div style="text-align: center; margin-bottom: 10px;">
			<img src="{% static 'myapp/logo-wo-bg.png' %}" alt="TomaSearch Logo" style="max-width: 300px; height: auto;">
		</div>

		<!-- Download button -->
		<form method="get" action="{% url 'download_csv' %}" style="text-align: center; padding-top: 40px;">
			<button type="submit" class="btn">Download CSV</button>
		</form>
		<!-- Results table -->
		<table id="resultsTable">
			<thead>
				<tr>
					{% for col in columns %}
					<th>
					{{ col|capfirst }}
					<button class="sort-btn" onclick="toggleDropdown(event, {{ forloop.counter0 }})">▼</button>
					<div class="dropdown" id="dropdown-{{ forloop.counter0 }}" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; z-index:1000;">
						<div onclick="sortTable({{ forloop.counter0 }}, 'asc')">Sort ascending</div>
						<div onclick="sortTable({{ forloop.counter0 }}, 'desc')">Sort descending</div>
						<div onclick="clearSort()">Clear sorting</div>
					</div>
					</th>
					{% endfor %}
				</tr>
			</thead>

			<tbody>
				{% for row in results %}
				<tr>
					{% for col in columns %}
					<td>
					{% if col == "p_value" %}
						{{ row|get_attribute:col|scientific_notation }}
					{% else %}
						{{ row|get_attribute:col }}
					{% endif %}
					</td>
					{% endfor %}
				</tr>
				{% endfor %}
			</tbody>
		</table>

		<!-- Button to scroll to the top -->
		<button id="scrollTopBtn" onclick="scrollToTop()">↑</button>

		<script>
			// Dropdown functionality
			function toggleDropdown(event, colIndex) {
				event.stopPropagation();
				closeAllDropdowns();
				const dropdown = document.getElementById('dropdown-' + colIndex);
				if (dropdown.style.display === 'block') {
				dropdown.style.display = 'none';
				} else {
				dropdown.style.display = 'block';
				// Posicionar dropdown justo debajo del botón
				const btn = event.target;
				const rect = btn.getBoundingClientRect();
				dropdown.style.position = 'fixed';
				dropdown.style.top = (rect.bottom + 2) + 'px';
				dropdown.style.left = rect.left + 'px';
				}
			}

			function closeAllDropdowns() {
				document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
			}

			document.addEventListener('click', closeAllDropdowns);
			// Store original order of rows
			let originalRows = [];
			const tbody = document.querySelector("#resultsTable tbody");
			if (tbody) {
				originalRows = Array.from(tbody.rows);
			}

			// Order table function
			function sortTable(colIndex, direction) {
				const rows = Array.from(tbody.rows);
				rows.sort((a, b) => {
				const cellA = a.cells[colIndex].innerText.trim();
				const cellB = b.cells[colIndex].innerText.trim();

				const numA = parseFloat(cellA.replace(/[^0-9.\-eE]/g, ""));
				const numB = parseFloat(cellB.replace(/[^0-9.\-eE]/g, ""));

				if (!isNaN(numA) && !isNaN(numB)) {
					return direction === 'asc' ? numA - numB : numB - numA;
				} else {
					return direction === 'asc' ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
				}
				});

				rows.forEach(row => tbody.appendChild(row));
				closeAllDropdowns();
			}

			function clearSort() {
				originalRows.forEach(row => tbody.appendChild(row));
				closeAllDropdowns();
			}

			// Show the scroll-to-top button when scrolling down
			window.onscroll = function() {
				const btn = document.getElementById("scrollTopBtn");
				if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
				btn.style.display = "block";
				} else {
				btn.style.display = "none";
				}
			};

			function scrollToTop() {
				window.scrollTo({ top: 0, behavior: 'smooth' });
			}
		</script>
	</body>
</html>
